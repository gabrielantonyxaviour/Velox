# Prompt 2: Update Solver SDK with Quadratic Curve Calculations

## Goal
Update the Solver SDK to calculate Dutch auction prices using the **same quadratic curve** as the contract. This ensures solvers can accurately predict prices and accept at the right time.

## Current Implementation (Linear)
```typescript
// VeloxSolver.ts lines 626-633
calculateTimeToPrice(dutch: DutchAuction, targetPrice: bigint): bigint {
  const priceRange = dutch.startPrice - dutch.endPrice;
  const priceDropNeeded = dutch.startPrice - targetPrice;
  return (priceDropNeeded * dutch.duration) / priceRange;
}
```

## New Implementation (Quadratic)
The curve formula: `price = start_price - price_range * (elapsed/duration)^2`

Inverse (time to price): `elapsed = duration * sqrt((start_price - target_price) / price_range)`

## Changes Required

### 1. Add `calculateDutchPrice` function in VeloxSolver.ts
```typescript
/**
 * Calculate Dutch auction price at a given elapsed time using quadratic decay
 * Formula: price = startPrice - priceRange * (elapsed/duration)^2
 */
calculateDutchPrice(dutch: DutchAuction, elapsedSeconds: bigint): bigint {
  if (elapsedSeconds >= dutch.duration) {
    return dutch.endPrice;
  }
  if (elapsedSeconds <= 0n) {
    return dutch.startPrice;
  }

  const priceRange = dutch.startPrice - dutch.endPrice;
  const elapsedSquared = elapsedSeconds * elapsedSeconds;
  const durationSquared = dutch.duration * dutch.duration;
  const decay = (priceRange * elapsedSquared) / durationSquared;

  return dutch.startPrice - decay;
}
```

### 2. Update `calculateTimeToPrice` function
Use inverse quadratic formula:
```typescript
/**
 * Calculate time until Dutch price reaches target price (quadratic curve)
 * Inverse of: price = startPrice - priceRange * (t/duration)^2
 * Solving for t: t = duration * sqrt((startPrice - price) / priceRange)
 */
calculateTimeToPrice(dutch: DutchAuction, targetPrice: bigint): bigint {
  if (targetPrice >= dutch.startPrice) return 0n;
  if (targetPrice <= dutch.endPrice) return dutch.duration;

  const priceRange = dutch.startPrice - dutch.endPrice;
  const priceDropNeeded = dutch.startPrice - targetPrice;

  // t = duration * sqrt(priceDropNeeded / priceRange)
  // Using integer approximation: t = duration * sqrt(priceDropNeeded) / sqrt(priceRange)
  const sqrtDrop = this.bigIntSqrt(priceDropNeeded * 1_000_000n); // Scale for precision
  const sqrtRange = this.bigIntSqrt(priceRange * 1_000_000n);

  return (dutch.duration * sqrtDrop) / sqrtRange;
}

/**
 * Integer square root using Newton's method
 */
private bigIntSqrt(n: bigint): bigint {
  if (n < 0n) throw new Error('Square root of negative number');
  if (n === 0n) return 0n;
  if (n === 1n) return 1n;

  let x = n;
  let y = (x + 1n) / 2n;
  while (y < x) {
    x = y;
    y = (x + n / x) / 2n;
  }
  return x;
}
```

### 3. Add local price calculation for offline use
```typescript
/**
 * Get current Dutch auction price calculated locally (not from contract)
 * Useful for strategy planning without RPC calls
 */
getCurrentDutchPriceLocal(dutch: DutchAuction): bigint {
  const now = BigInt(Math.floor(Date.now() / 1000));
  const elapsed = now - dutch.startTime;
  return this.calculateDutchPrice(dutch, elapsed);
}
```

### 4. Update dutch-solver.ts example
Update the solver strategy to use quadratic calculations.

## Files to Modify
- `solver-sdk/src/VeloxSolver.ts` - Add quadratic calculations
- `solver-sdk/src/examples/dutch-solver.ts` - Update to use new methods

## Testing
After changes:
```bash
cd solver-sdk && npm run build
```
