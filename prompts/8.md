# Prompt 8: End-to-End Testing and Verification

## Goal
Verify all updates work correctly together through manual testing and integration checks.

## Pre-requisites
- [ ] Prompt 1 completed: Contracts deployed to new address
- [ ] Prompt 2-3 completed: SDK updated
- [ ] Prompt 4-7 completed: Frontend updated

## Testing Steps

### 1. Contract Verification

```bash
# Verify submission registry initialized
movement move view --function-id 'NEW_ADDRESS::submission::get_total_intents' \
  --args address:NEW_ADDRESS --profile velox-new

# Verify solver registry initialized
movement move view --function-id 'NEW_ADDRESS::solver_registry::get_total_solvers' \
  --args address:NEW_ADDRESS --profile velox-new

# Verify settlement fee config
movement move view --function-id 'NEW_ADDRESS::settlement::get_fee_bps' \
  --args address:NEW_ADDRESS --profile velox-new
# Expected: 30 (0.3%)
```

### 2. Frontend Smoke Test

**Start dev server:**
```bash
cd frontend
npm run dev
```

**Test each flow:**

1. **Wallet Connection**
   - Connect with Privy
   - Connect with native wallet
   - Verify address displays correctly

2. **Swap Intent (No Auction)**
   - Select tokens
   - Enter amounts
   - Submit transaction
   - Verify intent appears in history
   - Check status shows "Active"

3. **Swap Intent (Dutch Auction)**
   - Enable Dutch auction option
   - Set start price and duration
   - Submit and verify
   - Check Dutch price countdown displays

4. **Limit Order**
   - Set limit price
   - Set expiry
   - Submit and verify
   - Confirm partial fills are automatically enabled

5. **TWAP Order**
   - Configure chunks and interval
   - Submit and verify
   - Check chunk progress displays

6. **Cancel Intent**
   - Cancel an active intent
   - Verify refund received
   - Check status shows "Cancelled"

### 3. SDK Verification

**Run SDK test script:**
```typescript
// test-sdk.ts
import { VeloxSolver } from '@velox/solver-sdk';

async function testSDK() {
  const solver = new VeloxSolver({
    rpcUrl: 'https://aptos.testnet.porto.movementlabs.xyz/v1',
    registryAddr: 'NEW_ADDRESS',
    feeConfigAddr: 'NEW_ADDRESS',
    privateKey: process.env.SOLVER_KEY,
  });

  // 1. Fetch an active intent
  const intents = await solver.fetchActiveIntents();
  console.log('Active intents:', intents.length);

  // 2. Check if can fill
  if (intents.length > 0) {
    const canFill = await solver.canFill(intents[0].id);
    console.log('Can fill:', canFill);

    // 3. Calculate min output
    const minOutput = await solver.calculateMinOutput(
      intents[0].id,
      intents[0].escrowRemaining
    );
    console.log('Min output:', minOutput.toString());
  }
}
```

### 4. Data Display Verification

**Check all IntentRecord fields display:**

| Field | Location | Verified |
|-------|----------|----------|
| id | Intent list, detail page | [ ] |
| user | Detail page header | [ ] |
| createdAt | Detail page, list | [ ] |
| intent type | Badge, icon | [ ] |
| auction state | Status section | [ ] |
| status | Badge everywhere | [ ] |
| escrowRemaining | Progress bar | [ ] |
| totalOutputReceived | Amount section | [ ] |
| fills | History table | [ ] |
| chunksExecuted | TWAP/DCA progress | [ ] |
| nextExecution | Countdown | [ ] |

### 5. Auction Feature Testing

**Sealed Bid:**
1. Create intent with sealed-bid auction
2. Wait for auction to end
3. Verify winner determination works
4. Verify only winner can fill

**Dutch Auction:**
1. Create intent with Dutch auction
2. Verify price decay displays correctly
3. Verify price matches contract calculation
4. Accept auction and verify fill works

### 6. Error Handling

Test these error scenarios:

1. Submit with expired deadline → Shows error
2. Submit with zero amount → Shows error
3. Cancel already filled intent → Shows error
4. Fill with too low output → Shows error
5. Fill past deadline → Shows error
6. Network errors → Shows retry option

### 7. Performance Check

- Intent list loads < 2 seconds
- Detail page loads < 1 second
- Transaction confirmations show loading state
- No duplicate API calls in network tab
- Proper caching of static data (fee %, addresses)

## Verification Checklist

### Contracts
- [ ] All modules deployed
- [ ] All modules initialized
- [ ] Test tokens mintable
- [ ] View functions return correct data

### SDK
- [ ] Function names updated (fill_*)
- [ ] feeConfigAddr passed correctly
- [ ] fillInput parameter works
- [ ] IntentRecord parsing complete
- [ ] No scheduled module references

### Frontend
- [ ] VELOX_ADDRESS updated
- [ ] Token addresses updated
- [ ] Status displays "Active" not "Pending"
- [ ] Partial fill progress shows
- [ ] Fills history table works
- [ ] Auction UI functional
- [ ] TWAP/DCA progress shows
- [ ] All view functions work
- [ ] Error handling works

## Common Issues and Fixes

**Issue: "Module not found" error**
- Fix: Ensure VELOX_ADDRESS is updated in all files

**Issue: Status shows wrong value**
- Fix: Update parseIntentStatus to handle Move enum variants

**Issue: Auction not displaying**
- Fix: Check parseAuctionState handles all variant types

**Issue: Amounts showing as 0**
- Fix: Ensure BigInt conversion from contract responses

**Issue: TWAP chunks not updating**
- Fix: Check nextExecution polling is active
