import{jsxs as e,Fragment as t,jsx as a}from"react/jsx-runtime";import i from"@heroicons/react/24/outline/CheckCircleIcon";import{useState as n,useEffect as r}from"react";import{createWalletClient as o,custom as s,publicActions as d,createPublicClient as c,http as m,formatUnits as l}from"viem";import{addToDefaultChains as u}from"@privy-io/js-sdk-core";import{b as p,c as h,R as g}from"./Layouts-Bmf8DxNP.mjs";import{B as f}from"./ModalHeader-BTru6YQw.mjs";import{C as v}from"./ScreenHeader-Biz1wq02.mjs";import{t as I}from"./FundWalletMethodHeader-CS84Ots9.mjs";import{N as j}from"./index-CJMgUOnw.mjs";import{u as w,t as T}from"./context-DRLoVlsO.mjs";import{u as y,a as b,b as C}from"./internal-context-e-Eni5bG.mjs";import{Q as S,D as N}from"./useActiveWallet-BeOB3HTh.mjs";import{a as A}from"./get-is-unified-wallet-gMDXpX6C.mjs";import{u as x}from"./useGetTokenPrice-CDPxMEO-.mjs";import{u as E}from"./useWallets-kObl6ZLS.mjs";import{O as k}from"./analytics-mkkvFRju.mjs";import{g as F,t as B,a as U,b as L,c as P,u as M}from"./reservoir-kvLjIrEo.mjs";import{w as W}from"./index-NL2cPmJD.mjs";import{g as q}from"./getChainName-DjpPdUSc.mjs";import{g as D,a as H}from"./transaction-CnfuREWo.mjs";import{g as O,B as R}from"./BridgeNetworkSelectionView-BXBCujiq.mjs";import{a as $}from"./getPublicClient-A9RSftUZ.mjs";import{T as _}from"./TransferOrBridgeLoadingScreen-BY7Eot6x.mjs";import"styled-components";import"@heroicons/react/24/outline/ArrowLeftIcon";import"@heroicons/react/24/outline/ArrowRightIcon";import"@heroicons/react/24/outline/QuestionMarkCircleIcon";import"@heroicons/react/24/outline/XMarkIcon";import"tinycolor2";import"ofetch";import"zustand";import"react-device-detect";import"./prepareFundingModalData-BVTcQcmw.mjs";import"eventemitter3";import"./events-context-CI0iqAXA.mjs";import"viem/utils";import"./useGetSolPrice-Cfm8o9C5.mjs";import"uuid";import"jose";import"@coinbase/wallet-sdk";import"@privy-io/ethereum";import"mipd";import"@privy-io/popup";import"./paths-3HW55qZg.mjs";import"./usePrivy-BWtc2XF-.mjs";import"@scure/base";import"@headlessui/react";import"@walletconnect/ethereum-provider";import"@privy-io/urls";import"js-cookie";import"./frame-CwE9r3cT.mjs";import"@privy-io/routes";import"x402/client";import"@privy-io/api-base";import"viem/accounts";import"./use-sign-with-user-signer-eEm9Olt_.mjs";import"./getEmbeddedConnectedWallet-CM6cDQCS.mjs";import"./getFormattedUsdFromLamports-B6EqSEho.mjs";import"./getErc20Balance-CaKjNAs9.mjs";import"./Button-BCV6mjvS.mjs";import"./Row-CG0lSY5Z.mjs";import"./ErrorMessage-Cx8GKGhL.mjs";import"./Value-B4M62ove.mjs";import"./LoadingSkeleton-CHdaq3pb.mjs";import"./Subtitle-DkvfP2Ev.mjs";import"./Title-D0pfZff-.mjs";import"@heroicons/react/24/outline/WalletIcon";import"./Chip-Bsgj4Yc-.mjs";import"./NetworkIcon-B48ilzF8.mjs";import"@heroicons/react/24/outline/GlobeAltIcon";import"./shared-CtYf3O54.mjs";import"@heroicons/react/24/outline/ChevronDownIcon";import"./formatErc20TokenAmount-BuPk9xcy.mjs";import"./ethers-Bl5aM5Gz.mjs";import"./styles-DY17fuAX.mjs";import"./InjectedWalletIcon-DLcYOGDj.mjs";import"./Address-BUmpXgsy.mjs";import"lucide-react";const V={component:()=>{let V=w(),{rpcConfig:G,appId:Q,closePrivyModal:z,createAnalyticsEvent:X}=y(),{navigate:Y,setModalData:J,data:K}=A(),Z=w(),{wallets:ee}=E(),[te,ae]=n(null),[ie,ne]=n(null),[re,oe]=n([]),[se,de]=n(0),[ce,me]=n(!1),[le,ue]=n(!1),[pe,he]=n(!1),[ge,fe]=n(!1),[ve,Ie]=n(),[je,we]=n();if(!K?.funding||"solana"!==K.funding.chainType)throw Error("Invalid funding data");let{address:Te,chain:ye,connectedWallet:be}=K.funding,[Ce,Se]=n(K.funding.amount),Ne=("ethereum"===be?.type?be:void 0)??ee[0],Ae=S(Ne?.walletClientType||"unknown"),xe=Ae?.name||"wallet",[Ee,ke]=n(null);r((()=>{(async()=>{if(!Ne)return;let e=await Ne.getEthereumProvider();ke(o({account:Ne.address,transport:s(e)}).extend(d))})().catch(console.error)}),[Ne]);let[Fe,Be]=n(0n),Ue=D(Fe);r((()=>{let e=V.solanaRpcs[ye];e?W({rpc:e.rpc,address:Te}).then((e=>Be(BigInt(e)))).catch(console.error):console.warn("Unable to load solana rpc, skipping balance")}),[]);let[Le,Pe]=n(),{tokenPrice:Me}=x("solana"),{fundingAmountInBaseUnit:We,fundingAmountInUsd:qe}=H({amount:Ce,fee:0n,tokenPrice:Me,isUsdc:K.funding.isUSDC});if(r((()=>{(async()=>{if(!Ee||!Ne)return;let e=["solana:testnet","solana:devnet"].includes(ye);e&&console.warn("Solana testnets are not supported for bridging");let t=u(Z.chains).filter((({testnet:t})=>!!t===e)),a=(await O({chains:t,address:Ne.address,appId:Q,rpcConfig:G})).filter((e=>e.balance>0n));if(a.length<1)return void ae(new b(`Wallet ${N(Ne.address)} does not have enough funds.`,void 0,C.INSUFFICIENT_BALANCE));a.sort(((e,t)=>Number(t.balance-e.balance)));let i=(await Promise.allSettled(a.map((async e=>({...e,quote:await F({isTestnet:!1,input:B({appId:Q,amount:We.toString(),user:Ne.address,recipient:Te,destinationChainId:L,destinationCurrency:U,originChainId:e.chain.id})})}))))).filter((e=>"fulfilled"===e.status)).map((e=>e.value));if(i.length<1)return void ae(new b(`Unable to fetch quotes for bridging. Wallet ${N(Ne.address)} does not have enough funds.`,void 0,C.INSUFFICIENT_BALANCE));let n=i.map((({quote:e,balance:t,chain:a})=>({bridgeTx:P(e),balance:t,chain:a,isErc20Quote:!1}))).filter((({bridgeTx:e})=>!!e));if(n.length>1)return void oe(n);let r=n.at(0);r?(ue(!0),Pe({data:r.bridgeTx.data,to:r.bridgeTx.to,value:r.bridgeTx.value,chain:r.chain})):ae(new b(`Unable to select bridge option from quotes. Wallet ${N(Ne.address)} does not have enough funds.`,void 0,C.INSUFFICIENT_BALANCE))})().catch(console.error)}),[Ee]),r((()=>{(async()=>{let e,t;if(!Ee||!Ne||ce||pe||!Le)return;me(!0);let a=c({chain:Le.chain,transport:m($(Le.chain,G,Q))});try{e=await a.prepareTransactionRequest({account:Ne.address,to:Le.to,chain:Le.chain,data:Le.data,value:BigInt(Le.value??0)})}catch(e){console.error(e),re.length>1&&ne(e.shortMessage??"Something went wrong")}if(e){me(!1),he(!0);try{await Ee.switchChain({id:Le.chain.id})}catch(e){await Ee.addChain({chain:Le.chain}),await Ee.switchChain({id:Le.chain.id})}try{t=await Ee.sendTransaction(e)}catch(e){console.error(e),"TransactionExecutionError"===e.name&&(re.length<1?ae(new b(e.shortMessage,void 0,C.TRANSACTION_FAILURE)):ne(e.shortMessage??"Something went wrong"))}if(t)return await Ee.waitForTransactionReceipt({hash:t}),le?(we("pending"),void Ie(t)):(he(!1),fe(!0),void X({eventName:k,payload:{provider:"external",status:"success",txHash:t,address:Ne.address,chainId:Le.chain.id,chainType:"ethereum",value:Le.value?l(BigInt(Le.value),18):void 0,token:"ETH",destination:Te,destinationClusterName:"mainnet-beta",destinationChainType:"solana",destinationValue:l(We,9),destinationToken:"SOL"}}));he(!1)}else me(!1)})().catch(console.error)}),[Ee,Le]),M({transactionHash:ve,isTestnet:!1,bridgingStatus:je,setBridgingStatus:we,onSuccess({transactionHash:e}){ue(!1),fe(!0),X({eventName:k,payload:{provider:"external",status:"success",txHash:e,address:Ne?.address,chainId:Le?.chain.id,chainType:"ethereum",value:Le?.value?l(BigInt(Le.value),18):void 0,token:"ETH",destination:Te,destinationClusterName:"mainnet-beta",destinationChainType:"solana",destinationValue:l(We,9),destinationToken:"SOL"}})},onFailure({error:e}){ue(!1),ae(e)}}),r((()=>{te&&(J({funding:K?.funding,solanaFundingData:K?.solanaFundingData,sendTransaction:K?.sendTransaction,errorModalData:{error:te,previousScreen:"TransferFromWalletScreen"}}),Y("ErrorScreen",!1))}),[te]),r((()=>{if(!ge)return;let e=setTimeout(z,T);return()=>clearTimeout(e)}),[ge]),ge/*#__PURE__*/)return e(t,{children:[/*#__PURE__*/a(I,{}),/*#__PURE__*/a(p,{}),/*#__PURE__*/e(h,{children:[/*#__PURE__*/a(i,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),/*#__PURE__*/a(v,{title:"Success!",description:`Youâ€™ve successfully added ${Ce} SOL to your ${Z.name} wallet. It may take a minute before the funds are available to use.`})]}),/*#__PURE__*/a(g,{}),/*#__PURE__*/a(f,{})]});let De=re[se];return re.length>1&&De?/*#__PURE__*/a(R,{displayName:xe,configuredFundingChain:ye,formattedBalance:Ue,fundingAmount:Ce,fundingCurrency:"SOL",fundingAmountInUsd:qe,options:re,selectedOption:De,isPreparing:ce,isSubmitting:pe,addressToFund:Te,fundingWalletAddress:Ne?.address||"",errorMessage:ie,onSubmit:()=>{K.funding?.amount!==Ce?async function(){if(Ne&&De)try{let e=await F({isTestnet:!1,input:B({appId:Q,amount:We.toString(),user:Ne.address,recipient:Te,destinationChainId:L,destinationCurrency:U,originChainId:De.chain.id})}),t=P(e);if(!t)throw Error("Invalid transaction request");ue(!0),Pe({data:t.data,to:t.to,value:t.value,chain:De.chain})}catch(e){console.error(e),ae(new b("Unable to fetch quotes for bridging",e,C.INSUFFICIENT_BALANCE))}}().catch(console.error):Pe({to:De.bridgeTx.to,data:De.bridgeTx.data,value:De.bridgeTx.value,chain:De.chain})},onSelect:e=>{e!==se&&(ne(null),de(e))},onAmountChange:Se}):pe&&Ne?/*#__PURE__*/a(_,{walletClientType:Ne?.walletClientType||"unknown",displayName:xe,addressToFund:Te,isBridging:le,isErc20Flow:!1,chainId:"solana",chainName:q(ye),totalPriceInUsd:void 0,totalPriceInNativeCurrency:void 0,gasPriceInUsd:void 0,gasPriceInNativeCurrency:void 0}):
/*#__PURE__*/e(t,{children:[/*#__PURE__*/a(I,{}),/*#__PURE__*/a(j,{}),/*#__PURE__*/a("div",{style:{marginTop:"1rem"}}),/*#__PURE__*/a(f,{})]})}};export{V as AwaitingEvmToSolBridgingScreen,V as default};
