"use strict";var e=require("react/jsx-runtime"),t=require("@heroicons/react/24/outline/CheckCircleIcon"),a=require("react"),n=require("@privy-io/js-sdk-core"),r=require("./Button-BXkfCTro.js"),s=require("./Layouts-dRL0OSpp.js"),o=require("./ModalHeader-DRaJvD2v.js"),i=require("./ScreenHeader-CyURV6Ti.js"),l=require("./FundWalletMethodHeader-BGagZe1_.js"),u=require("./InjectedWalletIcon-UY3nMvZo.js"),c=require("./index-CRFXS9pP.js"),d=require("./Value-C-XtZyFa.js"),m=require("./Row-CxDF-VMy.js"),g=require("./context-CcgGREUw.js"),p=require("./internal-context-NWsAL807.js"),f=require("./get-is-unified-wallet-JejAvbr5.js"),h=require("./useWallets-Cwi9URDf.js"),S=require("./useGetTokenPrice-DoyKddna.js"),j=require("./analytics-C6C_4JmG.js"),I=require("@solana-program/system"),T=require("@solana/kit"),x=require("@solana-program/token"),C=require("./getFormattedUsdFromLamports-Mu2fqwL2.js"),q=require("./getUsdcMintAddress-REYZSOb9.js"),F=require("./useSolanaRpcClient-BM36XRol.js"),v=require("./getChainName-C4rO8-3n.js"),y=require("./prepareFundingModalData-DkGmcQac.js");function w(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("styled-components"),require("./useActiveWallet-DTCrzsoG.js"),require("zustand"),require("react-device-detect"),require("./events-context-Di6--rDg.js"),require("viem"),require("viem/utils"),require("./getPublicClient-CGlodIp_.js"),require("./useWallets-ggeQUC3m.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("@heroicons/react/24/outline/WalletIcon"),require("./LoadingSkeleton-DoCrfGnl.js"),require("tinycolor2"),require("ofetch"),require("./usePrivy-CyUYnFHC.js"),require("eventemitter3"),require("@scure/base"),require("./use-sign-with-user-signer-BcAsQTGF.js"),require("./useGetSolPrice-C986iVoO.js");var L=/*#__PURE__*/w(t);function E({rows:t}){/*#__PURE__*/return e.jsx(m.Rows,{children:t.filter((e=>!!e)).map(((t,a)=>null!=t.value||t.isLoading?/*#__PURE__*/e.jsxs(m.Row,{children:[/*#__PURE__*/e.jsx(d.LabelSm,{children:t.label}),/*#__PURE__*/e.jsx(d.Value,{$isLoading:t.isLoading,children:t.value})]},a):null))})}function A(e){return BigInt(Math.floor(1e9*parseFloat(e)))}function P(e){return+U.format(parseFloat(e.toString())/1e9)}let U=Intl.NumberFormat(void 0,{maximumFractionDigits:8});async function k({tx:e,solanaClient:t,amount:a,asset:n,tokenPrice:r}){if(!e)return null;if("SOL"===n&&r){let n=A(a),s=C.getFormattedUsdFromLamports(n,r),o=await F.fetchTransactionEstimatedFees({solanaClient:t,tx:e});return{amountInUsd:s,feeInUsd:r?C.getFormattedUsdFromLamports(o,r):void 0,totalInUsd:C.getFormattedUsdFromLamports(n+o,r)}}if("USDC"===n&&r){let n="$"+a,s=await F.fetchTransactionEstimatedFees({solanaClient:t,tx:e}),o=function(e,t){let a=parseFloat(e.toString())/C.LAMPORTS_PER_SOL*t;return a<.01?0:a}(s,r);return{amountInUsd:n,feeInUsd:C.getFormattedUsdFromLamports(s,r),totalInUsd:"$"+(parseFloat(a)+o).toFixed(2)}}if("SOL"===n){let n=A(a),r=await F.fetchTransactionEstimatedFees({solanaClient:t,tx:e});return{amountInSol:a+" SOL",feeInSol:P(r)+" SOL",totalInSol:P(n+r)+" SOL"}}return{amountInUsdc:a+" USDC",feeInSol:P(await F.fetchTransactionEstimatedFees({solanaClient:t,tx:e}))+" SOL"}}const W={component:function(){let t=g.useAppConfig(),{closePrivyModal:d,createAnalyticsEvent:m}=p.usePrivyInternal(),{data:w,setModalData:P,navigate:U}=f.usePrivyModal(),{wallets:W}=h.useWallets(),[M,b]=a.useState("preparing"),[N,O]=a.useState(),[R,D]=a.useState(),[_,B]=a.useState();if(!w?.solanaFundingData)throw Error("Funding config is missing");if(!w.solanaFundingData.sourceWalletData)throw Error("Funding config is missing source wallet data");let{amount:$,asset:G,chain:H,sourceWalletData:V,destinationAddress:K,afterSuccessScreen:X}=w.solanaFundingData,Y=W.find((e=>e.address===V.address&&y.toSolanaWalletClientType(V.walletClientType)===y.toSolanaWalletClientType(e.standardWallet.name))),z=F.useSolanaRpcClient()(H),{tokenPrice:Q,isTokenPriceLoading:J}=S.useGetTokenPrice("solana");return a.useEffect((()=>{if("preparing"!==M||J||!Y)return;let e="SOL"===G?A($):function(e){return BigInt(Math.floor(1e6*parseFloat(e)))}($);D({amount:("SOL"===G&&Q?C.getFormattedUsdFromLamports(e,Q):$)??$}),("SOL"===G?async function({solanaClient:e,source:t,destination:a,amountInLamports:n}){let{value:r}=await e.rpc.getLatestBlockhash().send(),s={address:t},o=T.pipe(T.createTransactionMessage({version:0}),(e=>T.setTransactionMessageFeePayerSigner(s,e)),(e=>T.setTransactionMessageLifetimeUsingBlockhash(r,e)),(e=>T.appendTransactionMessageInstruction(I.getTransferSolInstruction({amount:n,source:s,destination:a}),e)),(e=>T.compileTransaction(e)));return new Uint8Array(T.getTransactionEncoder().encode(o))}({solanaClient:z,source:Y.address,destination:K,amountInLamports:e}):async function({solanaClient:e,source:t,destination:a,amountInBaseUnits:n}){let r=q.getUsdcMintAddress(e.chain),{value:s}=await e.rpc.getLatestBlockhash().send(),o={address:t},[i]=await x.findAssociatedTokenPda({mint:r,owner:t,tokenProgram:C.TOKEN_PROGRAM_ID}),[l]=await x.findAssociatedTokenPda({mint:r,owner:a,tokenProgram:C.TOKEN_PROGRAM_ID}),[u,c]=await Promise.all([e.rpc.getAccountInfo(i,{commitment:"confirmed",encoding:"jsonParsed"}).send().catch((()=>null)),e.rpc.getAccountInfo(l,{commitment:"confirmed",encoding:"jsonParsed"}).send().catch((()=>null))]);if(!u?.value)throw Error(`Source token account does not exist for address: ${t}`);let d=x.getCreateAssociatedTokenIdempotentInstruction({payer:o,ata:l,owner:a,mint:r}),m=T.pipe(T.createTransactionMessage({version:0}),(e=>T.setTransactionMessageFeePayerSigner(o,e)),(e=>T.setTransactionMessageLifetimeUsingBlockhash(s,e)),(e=>c?.value?e:T.appendTransactionMessageInstruction(d,e)),(e=>T.appendTransactionMessageInstruction(x.getTransferInstruction({source:i,destination:l,authority:o,amount:n}),e)),(e=>T.compileTransaction(e)));return new Uint8Array(T.getTransactionEncoder().encode(m))}({solanaClient:z,source:Y.address,destination:K,amountInBaseUnits:e})).then(O).catch((e=>{b("error"),B(e)}))}),[M,$,G,H,Y,K,J,Q]),a.useEffect((()=>{"preparing"===M&&N&&k({tx:N,solanaClient:z,amount:$,asset:G,tokenPrice:Q}).then((e=>{b("loaded"),D({amount:e?.amountInUsd??e?.amountInUsdc??e?.amountInSol??$,fee:e?.feeInUsd??e?.feeInSol,total:e?.totalInUsd??e?.totalInSol})})).catch((e=>{b("error"),B(e)}))}),[N,$,G,M,Q]),a.useEffect((()=>{"error"===M&&_&&(P({errorModalData:{error:_,previousScreen:"FundSolWalletWithExternalSolanaWallet"},solanaFundingData:w.solanaFundingData}),U("ErrorScreen",!1))}),[M,U]),a.useEffect((()=>{if("success"!==M)return;let e=setTimeout(X?()=>U(X):d,g.DEFAULT_SUCCESS_SCREEN_EXTRA_LONG_DURATION_MS);return()=>clearTimeout(e)}),[M]),"success"===M?/*#__PURE__*/e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(l.t,{}),/*#__PURE__*/e.jsx(s.RefactorSpacerTop,{}),/*#__PURE__*/e.jsxs(s.CenteredItemWithGap,{children:[/*#__PURE__*/e.jsx(L.default,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),/*#__PURE__*/e.jsx(i.CenteredScreenHeader,{title:"Success!",description:`Youâ€™ve successfully added ${$} ${G} to your ${t.name} wallet. It may take a minute before the funds are available to use.`})]}),/*#__PURE__*/e.jsx(s.RefactorSpacerBottom,{}),/*#__PURE__*/e.jsx(o.BlobbyFooter,{})]}):"preparing"===M||"loaded"===M||"sending"===M?/*#__PURE__*/e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(l.t,{}),/*#__PURE__*/e.jsx(s.CenteredItem,{style:{marginTop:"16px"},children:/*#__PURE__*/e.jsx(u.InjectedWalletIcon,{icon:Y?.standardWallet.icon,name:Y?.standardWallet.name})}),/*#__PURE__*/e.jsx(i.CenteredScreenHeader,{style:{marginTop:"8px",marginBottom:"12px"},title:"sending"===M&&Y?`Confirming with ${Y.standardWallet.name}`:"Confirm transaction"}),/*#__PURE__*/e.jsx(E,{rows:[{label:"Source",value:n.formatWalletAddress(V.address)},{label:"Destination",value:n.formatWalletAddress(K)},{label:"Network",value:v.getChainName(H)},{label:"Amount",value:R?.amount,isLoading:"preparing"===M},{label:"Estimated fee",value:R?.fee,isLoading:"preparing"===M},{label:"Total",value:R?.total,isLoading:"preparing"===M}]}),/*#__PURE__*/e.jsx(r.PrimaryButton,{style:{marginTop:"1rem"},loading:"preparing"===M||"sending"===M,onClick:function(){"loaded"===M&&N&&Y&&(b("sending"),async function({transaction:e,chain:t,sourceWallet:a,solanaClient:r}){let{hasFunds:s}=await F.simulateTransaction({solanaClient:r,tx:e});if(!s)throw new p.PrivyClientError(`Wallet ${n.formatWalletAddress(a.address)} does not have enough funds.`,void 0,p.PrivyErrorCode.INSUFFICIENT_BALANCE);let o=h.getAddressFromBuffer((await a.signAndSendTransaction({transaction:e,chain:t}).catch((e=>{throw new p.PrivyClientError("Transaction was rejected by the user",e,p.PrivyErrorCode.TRANSACTION_FAILURE)}))).signature);return await F.waitForSignatureConfirmation({rpcSubscriptions:r.rpcSubscriptions,signature:o,timeout:2e4}),o}({solanaClient:z,transaction:N,chain:H,sourceWallet:Y}).then((e=>{b("success"),m({eventName:j.ON_RAMP_COMPLETE_ANALYTICS_EVENT,payload:{provider:"external",status:"success",txHash:e,address:Y.address,value:$,chainType:"solana",clusterName:H,token:G,destinationAddress:K,destinationValue:$,destinationChainType:"solana",destinationClusterName:H,destinationToken:G}})})).catch((e=>{b("error"),B(e)})))},children:"Confirm"}),/*#__PURE__*/e.jsx(o.BlobbyFooter,{})]}):
/*#__PURE__*/e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(l.t,{}),/*#__PURE__*/e.jsx(c.NeutralSpinner,{}),/*#__PURE__*/e.jsx("div",{style:{marginTop:"1rem"}}),/*#__PURE__*/e.jsx(o.BlobbyFooter,{})]})}};exports.FundSolWalletWithExternalSolanaWallet=W,exports.default=W;
