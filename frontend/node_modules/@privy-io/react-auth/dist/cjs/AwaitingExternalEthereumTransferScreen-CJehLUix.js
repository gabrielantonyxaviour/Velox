"use strict";var e=require("react/jsx-runtime"),r=require("@heroicons/react/24/outline/CheckCircleIcon"),t=require("react"),i=require("viem"),n=require("@privy-io/js-sdk-core"),a=require("./Layouts-dRL0OSpp.js"),s=require("./ModalHeader-DRaJvD2v.js"),o=require("./ScreenHeader-CyURV6Ti.js"),u=require("./FundWalletMethodHeader-BGagZe1_.js"),d=require("./index-CRFXS9pP.js"),c=require("./context-CcgGREUw.js"),l=require("./internal-context-NWsAL807.js"),h=require("./useActiveWallet-DTCrzsoG.js"),g=require("./get-is-unified-wallet-JejAvbr5.js"),f=require("./useGetTokenPrice-DoyKddna.js"),m=require("./useWallets-ggeQUC3m.js"),v=require("./transfer-Cit146vy.js"),p=require("./formatErc20TokenAmount-DxwoWe7e.js"),C=require("./ethers-CWRVqVsu.js"),y=require("./analytics-C6C_4JmG.js"),q=require("./reservoir-CQGyEBb7.js"),E=require("./index-iQcFLOcm.js"),T=require("./BridgeNetworkSelectionView-DhE8OSNF.js"),I=require("./getErc20Balance-DknCauCO.js"),S=require("./getPublicClient-CGlodIp_.js"),j=require("./TransferOrBridgeLoadingScreen-mTz1kP-n.js");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("styled-components"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("tinycolor2"),require("ofetch"),require("zustand"),require("react-device-detect"),require("./prepareFundingModalData-DkGmcQac.js"),require("eventemitter3"),require("./events-context-Di6--rDg.js"),require("viem/utils"),require("./useGetSolPrice-C986iVoO.js"),require("uuid"),require("jose"),require("@coinbase/wallet-sdk"),require("@privy-io/ethereum"),require("mipd"),require("@privy-io/popup"),require("./paths-DizMb-lU.js"),require("./usePrivy-CyUYnFHC.js"),require("@scure/base"),require("@headlessui/react"),require("@walletconnect/ethereum-provider"),require("@privy-io/urls"),require("js-cookie"),require("./frame-B14fp9oC.js"),require("@privy-io/routes"),require("x402/client"),require("@privy-io/api-base"),require("viem/accounts"),require("./use-sign-with-user-signer-BcAsQTGF.js"),require("./getEmbeddedConnectedWallet-6TsVZJkD.js"),require("./Button-BXkfCTro.js"),require("./Row-CxDF-VMy.js"),require("./ErrorMessage-f0cRWc29.js"),require("./Value-C-XtZyFa.js"),require("./LoadingSkeleton-DoCrfGnl.js"),require("./Subtitle-Dtmrw8l5.js"),require("./Title-C-tHJvrb.js"),require("@heroicons/react/24/outline/WalletIcon"),require("./getChainName-C4rO8-3n.js"),require("./Chip-ChrHHazc.js"),require("./NetworkIcon-BZ9Mj6vV.js"),require("@heroicons/react/24/outline/GlobeAltIcon"),require("./shared-BPGwTh8c.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("./styles-D4VeJNv1.js"),require("./InjectedWalletIcon-UY3nMvZo.js"),require("./Address-Dqfr__Us.js"),require("lucide-react");var w=/*#__PURE__*/b(r);const A={component:()=>{let{rpcConfig:r,appId:b,closePrivyModal:A,createAnalyticsEvent:N}=l.usePrivyInternal(),{navigate:F,setModalData:x,data:P}=g.usePrivyModal(),B=c.useAppConfig(),{wallets:W}=m.useWallets(),[_,k]=t.useState(!1),[R,U]=t.useState(0n),[M,L]=t.useState(!1),[D,H]=t.useState(null),[Q,O]=t.useState(null),[$,G]=t.useState([]),[V,Y]=t.useState(0),[J,X]=t.useState(!1),[z,K]=t.useState(!1),[Z,ee]=t.useState(!1),[re,te]=t.useState(!1),[ie,ne]=t.useState(),[ae,se]=t.useState();if(!P?.funding||"ethereum"!==P.funding.chainType)throw Error("Invalid funding data");let{erc20ContractInfo:oe,chain:ue,connectedWallet:de}=P.funding,ce=P.funding.address,le=P.funding.erc20Address,[he,ge]=t.useState(P.funding.amount);t.useEffect((()=>{le&&!oe&&H(Error("Unable to fetch token details"))}),[]);let fe=!!le&&!!oe,me=fe?BigInt(parseFloat(he)*10**oe.decimals):i.parseEther(he),ve=("ethereum"===de?.type?de:void 0)??W[0],pe=h.useExternalWalletListing(ve?.walletClientType||"unknown"),Ce=pe?.name||"wallet",[ye,qe]=t.useState(null);t.useEffect((()=>{(async()=>{if(!ve)return;let e=await ve.getEthereumProvider();qe(i.createWalletClient({account:ve.address,transport:i.custom(e)}).extend(i.publicActions))})().catch(console.error)}),[ve]);let[Ee,Te]=t.useState(0n);t.useEffect((()=>{i.createPublicClient({chain:ue,transport:i.http(S.getJsonRpcEndpointFromChain(ue,r,b))}).getBalance({address:ce}).then(Te).catch(console.error)}),[]);let[Ie,Se]=t.useState(0n);t.useEffect((()=>{fe&&I.getErc20Balance({chain:ue,address:ce,appId:b,rpcConfig:r,erc20Address:le}).then((e=>Se(e.balance))).catch(console.error)}),[]);let{tokenPrice:je}=f.useGetTokenPrice(ue.id),[be,we]=t.useState({to:ce,chain:ue,value:me,data:void 0});t.useEffect((()=>{(async()=>{let e,t;if(!ye||!ve||J||Z)return;X(!0);let n=i.createPublicClient({chain:be.chain,transport:i.http(S.getJsonRpcEndpointFromChain(be.chain,r,b))});if(fe&&!be.data)return await n.simulateContract({address:le,chain:be.chain,abi:v.ERC20_TRANSFER_ABI_STUB,functionName:"transfer",args:[ce,me],account:ve.address}).catch((e=>{console.warn("Simulated token transfer failed with error, fetching bridge options.",e)}))?(X(!1),void we({to:le,chain:be.chain,data:i.encodeFunctionData({abi:v.ERC20_TRANSFER_ABI_STUB,functionName:"transfer",args:[ce,me]}),value:"0x0"})):(X(!1),void L(!0));try{e=await n.prepareTransactionRequest({account:ve.address,to:be.to,chain:be.chain,data:be.data,value:BigInt(be.value??0)})}catch(e){if(console.error(e),$.length>1)O(e.shortMessage??"Something went wrong");else if(z&&0===$.length)return void H(new l.PrivyClientError(`Wallet ${h.formatWalletAddress(ve.address)} does not have enough funds.`,void 0,l.PrivyErrorCode.INSUFFICIENT_BALANCE))}if(!e)return X(!1),void L(!0);X(!1),ee(!0),k(!0),U(e.gas);try{await ye.switchChain({id:be.chain.id})}catch(e){await ye.addChain({chain:be.chain}),await ye.switchChain({id:be.chain.id})}try{t=await ye.sendTransaction(e)}catch(e){if(console.error(e),"TransactionExecutionError"===e.name)if($.length<1){let r=e.shortMessage;(e.shortMessage.includes("rejected the request")||e.details.includes("rejected the request"))&&(r="User rejected the request."),H(new l.PrivyClientError(r,void 0,l.PrivyErrorCode.TRANSACTION_FAILURE))}else O(e.shortMessage??"Something went wrong")}if(t)return await ye.waitForTransactionReceipt({hash:t}),ee(!1),z?(ne(t),void se("pending")):(te(!0),x(E.addFundingResultToModalData(P,"completed",t,ve?.walletClientType,fe,oe,ue)),void N({eventName:y.ON_RAMP_COMPLETE_ANALYTICS_EVENT,payload:{provider:"external",status:"success",txHash:t,address:ve.address,chainId:be.chain.id,chainType:"ethereum",value:be.value?i.formatUnits(BigInt(be.value),oe?.decimals??18):void 0,token:oe?.symbol??le??"ETH",destinationAddress:ce,destinationChainId:ue.id,destinationChainType:"ethereum",destinationValue:me?i.formatUnits(me,oe?.decimals??18):void 0,destinationToken:oe?.symbol??le??ue.nativeCurrency.name}}));ee(!1)})().catch(console.error)}),[ye,be]),t.useEffect((()=>{(async()=>{if(!M||!ye||!ve)return;let e=n.addToDefaultChains(B.chains).filter((e=>e.id!==ue.id&&!!e.testnet==!!ue.testnet));fe&&e.unshift(ue);let t=await T.getBalanceForChains({chains:e,address:ve.address,appId:b,rpcConfig:r,includeUsdc:P.funding?.isUSDC}),i=fe?t.filter((e=>e.balance>0n)):t.filter((e=>e.balance>me)),a=fe&&t.every((e=>0n===e.balance));if(i.length<1)return void H(a?new l.PrivyClientError(`Wallet ${h.formatWalletAddress(ve.address)} doesn't have enough funds to cover gas fees. Top up your wallet and try again.`,void 0,l.PrivyErrorCode.INSUFFICIENT_BALANCE):new l.PrivyClientError(`Wallet ${h.formatWalletAddress(ve.address)} does not have enough funds.`,void 0,l.PrivyErrorCode.INSUFFICIENT_BALANCE));i.sort(((e,r)=>Number(fe?(r.erc20Balance??0n)-(e.erc20Balance??0n):r.balance-e.balance)));let s=i.flatMap((e=>{let r=[{...e,isErc20Quote:!1,isTestnet:!!ue.testnet,input:q.toGetQuoteInput({appId:b,amount:me.toString(),user:ve.address,recipient:ce,destinationChainId:ue.id,destinationCurrency:le,originChainId:e.chain.id})}];return fe&&le&&(e.erc20Balance??0n)>=me&&r.push({...e,isErc20Quote:!0,isTestnet:!!ue.testnet,input:q.toGetQuoteInput({appId:b,amount:me.toString(),user:ve.address,recipient:ce,destinationChainId:ue.id,destinationCurrency:le,originChainId:e.chain.id,originCurrency:e.erc20Address})}),r})),o=(await Promise.allSettled(s.map((async e=>({...e,quote:await q.getQuote(e)}))))).filter((e=>"fulfilled"===e.status)).map((e=>e.value));if(o.length<1)return void H(new l.PrivyClientError(`Wallet ${h.formatWalletAddress(ve.address)} does not have enough funds.`,void 0,l.PrivyErrorCode.INSUFFICIENT_BALANCE));let u=o.map((e=>({bridgeTx:q.toEvmTransactionRequestInfoFromQuote(e.quote),balance:e.balance,chain:e.chain,erc20Balance:e.erc20Balance,isErc20Quote:e.isErc20Quote}))).filter((e=>!!e.bridgeTx));if(u.length>1)return void G(u);let d=u[0];d?(K(!0),we({data:d.bridgeTx.data,to:d.bridgeTx.to,value:d.bridgeTx.value,chain:d.chain})):H(new l.PrivyClientError(`Wallet ${h.formatWalletAddress(ve.address)} does not have enough funds.`,void 0,l.PrivyErrorCode.INSUFFICIENT_BALANCE))})().catch(console.error)}),[M]),q.useBridgingStatusPolling({transactionHash:ie,isTestnet:!!ue.testnet,bridgingStatus:ae,setBridgingStatus:se,onSuccess({transactionHash:e}){K(!1),te(!0),x(E.addFundingResultToModalData(P,"completed",e,ve?.walletClientType,fe,oe,ue)),N({eventName:y.ON_RAMP_COMPLETE_ANALYTICS_EVENT,payload:{provider:"external",status:"success",txHash:e,address:ve?.address,chainId:be.chain.id,chainType:"ethereum",value:be.value?i.formatUnits(BigInt(be.value),oe?.decimals??18):void 0,token:oe?.symbol??le??"ETH",destinationAddress:ce,destinationChainId:ue.id,destinationChainType:"ethereum",destinationValue:me?i.formatUnits(me,oe?.decimals??18):void 0,destinationToken:oe?.symbol??le??ue.nativeCurrency.name}})},onFailure({error:e}){K(!1),H(e)}}),t.useEffect((()=>{D&&(x({funding:P?.funding,solanaFundingData:P?.solanaFundingData,sendTransaction:P?.sendTransaction,errorModalData:{error:D,previousScreen:"TransferFromWalletScreen"}}),F("ErrorScreen",!1))}),[D]);let Ae=!fe&&je?C.getDollarsFromStringFloat(he??"0",je):void 0,Ne=fe?R:C.sumWeiQuantities([R,me]),Fe=Ne&&je?C.getDollarsFromWei(Ne,je):void 0,xe=Ne?C.getNativeCurrencyFromWei(Ne,P?.funding?.erc20Address?P?.funding?.erc20ContractInfo?.symbol||"ETH":P?.funding?.chain.nativeCurrency.symbol||"ETH"):void 0,Pe=R&&je?C.getDollarsFromWei(R,je):void 0,Be=R?C.getNativeCurrencyFromWei(R,ue?.nativeCurrency?.symbol||"ETH"):void 0;if(t.useEffect((()=>{if(!re)return;let e=setTimeout(A,c.DEFAULT_SUCCESS_SCREEN_EXTRA_LONG_DURATION_MS);return()=>clearTimeout(e)}),[re]),re/*#__PURE__*/)return e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(u.t,{}),/*#__PURE__*/e.jsx(a.RefactorSpacerTop,{}),/*#__PURE__*/e.jsxs(a.CenteredItemWithGap,{children:[/*#__PURE__*/e.jsx(w.default,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),/*#__PURE__*/e.jsx(o.CenteredScreenHeader,{title:"Success!",description:`Youâ€™ve successfully added ${he} ${fe?oe.symbol:ue.nativeCurrency.symbol} to your ${B.name} wallet. It may take a minute before the funds are available to use.`})]}),/*#__PURE__*/e.jsx(a.RefactorSpacerBottom,{}),/*#__PURE__*/e.jsx(s.BlobbyFooter,{})]});let We=fe?`${p.formatErc20TokenAmount({amount:Ie,decimals:oe.decimals})}  ${oe.symbol}`:C.getNativeCurrencyFromWei(Ee,ue.nativeCurrency.symbol,3,!0),_e=$[V];return $.length>1&&_e?/*#__PURE__*/e.jsx(T.BridgeNetworkSelectionView,{displayName:Ce,configuredFundingChain:ue,erc20ContractInfo:oe,formattedBalance:We,fundingAmount:he,fundingCurrency:fe?oe.symbol:ue.nativeCurrency.symbol,fundingAmountInUsd:Ae,options:$,selectedOption:_e,isPreparing:J,isSubmitting:Z,addressToFund:ce,fundingWalletAddress:ve?.address||"",errorMessage:Q,onSubmit:()=>{P.funding?.amount!==he?async function(){if(ve&&_e)try{let e=await q.getQuote({isTestnet:!!ue.testnet,input:q.toGetQuoteInput({appId:b,amount:me.toString(),user:ve.address,recipient:ce,destinationChainId:ue.id,destinationCurrency:le,originChainId:_e.chain.id})}),r=q.toEvmTransactionRequestInfoFromQuote(e);if(!r)throw Error("Invalid transaction request");K(!0),we({data:r.data,to:r.to,value:r.value,chain:_e.chain})}catch(e){console.error(e),H(new l.PrivyClientError("Unable to fetch quotes for bridging",e,l.PrivyErrorCode.INSUFFICIENT_BALANCE))}}().catch(console.error):we({to:_e.bridgeTx.to,data:_e.bridgeTx.data,value:_e.bridgeTx.value,chain:_e.chain})},onSelect:e=>{e!==V&&(O(null),Y(e))},onAmountChange:ge}):_&&R&&ve&&P?.funding?/*#__PURE__*/e.jsx(j.TransferOrBridgeLoadingScreen,{walletClientType:ve?.walletClientType||"unknown",displayName:Ce,addressToFund:ce,isBridging:z,isErc20Flow:fe,totalPriceInUsd:Fe,totalPriceInNativeCurrency:xe,gasPriceInUsd:Pe,gasPriceInNativeCurrency:Be,chainId:ue.id,chainName:ue.name}):
/*#__PURE__*/e.jsxs(e.Fragment,{children:[/*#__PURE__*/e.jsx(u.t,{}),/*#__PURE__*/e.jsx(d.NeutralSpinner,{}),/*#__PURE__*/e.jsx("div",{style:{marginTop:"1rem"}}),/*#__PURE__*/e.jsx(s.BlobbyFooter,{})]})}};exports.AwaitingExternalEthereumTransferScreen=A,exports.default=A;
